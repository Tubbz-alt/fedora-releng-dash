<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The Fedora Release Engineering Dashboard">
    <meta name="author" content="Ralph Bean">
    <link href="css/pace.css" rel="stylesheet">
    <link rel="shortcut icon" href="assets/ico/favicon.ico">

    <title>Fedora Release Engineering Dashboard</title>

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/site.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
      <script src="assets/js/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <!-- Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container">
        <div class="page-header">
            <h1>Fedora Release Engineering Dashboard</h1>
        </div>
        <p class="lead">Track the status of the Fedora Release Engineering process.</p>
        <div id="widgets-container">
        </div>
    </div>

    <div id="footer">
      <div class="container">
          <p class="text-muted credit">Â©2013-2015 Red Hat, Inc., <a href="http://threebean.org">Ralph Bean </a>.  Get the <a href="https://github.com/fedora-infra/fedora-releng-dash">source</a>.</p>
      </div>
    </div>
    <script src="js/jquery.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/handlebars-v3.0.3.js"></script>
    <script id="row" type="text/x-handlebars-template">
    </script>
    <script id="layout" type="text/x-handlebars-template">
      {{#if fetched }}
        {{#if layout }}
          {{#each layout.groups}}
            {{>group}}
            <hr>
          {{/each}}
        {{ else }}
          <p>No data to display</p>
        {{/if}}
      {{ else }}
        {{>loading}}
      {{/if}}
    </script>
    <script id="group" type="text/x-handlebars-template">
       <div id="{{ id }}" class="group row">
         {{#if name}}
          <h3>{{ name }}</h3>
         {{/if}}
         {{#each components}}
           {{>component}}
         {{/each}}
       </div>
    </script>
    <script id="component" type="text/x-handlebars-template">
      <div id="{{ id }}" class="component col-md-6">
        <div class="component-header">
         {{#if name}}
           <h3>
             <a id="{{ id }}" href="#{{ id }}">{{ name }}</a>
           </h3>
         {{/if}}
        </div>
        <div class="component-content">
          {{>component_content}}
        </div>
      </div>
    </script>
    <script id="component_content" type="text/x-handlebars-template">
      {{#if fetched}}
        {{#if data}}
          {{#each data}}
            <p>
              {{#if message.link}}
                <a href="{{ message.link }}">
              {{/if}}
              <span class="log-name">{{ message.name }}</span>
              <span class="log-status">{{ message.status }}</span>
              <span class="log-timeago">{{ getTimeAgo timestamp }}</span>
              {{#if message.link}}
                </a>
              {{/if}}
              {{#if message.extra_text }}
                {{#if message.extra_link }}
                  <a href="{{ message.extra_link }}">
                {{/if}}
                <span class="log-extra_text">{{ message.extra_text }}</span>
                {{#if message.extra_link}}
                  </a>
                {{/if}}
              {{/if}}
            </p>
          {{/each}}
        {{ else }}
          <p>No results to display!</p>
        {{/if}}
      {{else}}
        {{>loading}}
      {{/if}}
    </script>
    <script id="loading" type="text/x-handlebars-template">
      <p>Loading...</p>
    </script>
    <script type="text/javascript" charset="utf-8">
      $(function () {
          var baseUrl = "http://localhost:5000";
          $('[type="text/x-handlebars-template"]').each(function (index, elem) {
              Handlebars.registerPartial(elem.id, elem.innerHTML);
          });
          Handlebars.registerHelper('getTimeAgo', function (timestamp) {
            var time = moment(timestamp.toString(), '%X');
            return time.fromNow();
          });
          Handlebars.registerHelper('isEqual', function (item, value) {
              return item == value;
          });
          function renderLayout(context) {
            var source = $('#layout').html();
            var template = Handlebars.compile(source);
            var html = template(context);
            $('#widgets-container').html(html);
          }

          function getLayout () {
            $.ajax({
                url: baseUrl + "/release-engineering-event-logs/layout",
                dataType: 'jsonp',
                success: function (data) {
                  renderLayout({fetched: true, layout: data});
                  fetchData();
                },
                error: function () {
                  renderLayout({fetched: true});
                }
            });
          }

          function fetchData () {
            $.ajax({
              url: baseUrl + "/release-engineering-event-logs",
              dataType: "jsonp",
              success: function (data) {
                var component_logs = {};
                for (i=0; i < data.length; i++) {
                  var log = data[i];
                  log.message = JSON.parse(log.message);
                  if (component_logs[log['category']]) {
                    component_logs[log['category']].push(log);
                  } else {
                    component_logs[log['category']] = [log];
                  }
                }
                var source = $('#component_content').html();
                var template = Handlebars.compile(source);
                $('.component').each(function (index, elem) {
                    $(this).find('.component-content').html(
                        template({
                          fetched: true,
                          data: (component_logs[elem.id] || []).slice(0, 8),
                        })
                    );
                });
              }
            });
          }

          function init () {
            renderLayout();
            getLayout();
          }
          init();
      });
    </script>
  </body>
</html>
